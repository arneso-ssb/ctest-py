name: Build wheels

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-wheels:
    name: cibuildwheel linux x86_64 (cp311-cp313)
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.12"

      - name: Build wheels with cibuildwheel
        uses: pypa/cibuildwheel@v3.3.0
        env:
          # Build only CPython 3.11â€“3.13 manylinux wheels for x86_64
          CIBW_BUILD: "cp311-manylinux_x86_64 cp312-manylinux_x86_64 cp313-manylinux_x86_64"
          CIBW_ARCHS_LINUX: "x86_64"

          # Install system dependencies inside the manylinux container before building
          # Needed for the native extension build (OpenSSL, libcurl, and pkg-config)
          CIBW_BEFORE_ALL_LINUX: |
            yum -y install openssl-devel libcurl-devel pkgconfig

          # Minimal import test for each built wheel
          CIBW_TEST_COMMAND: |
            python -c "import ctest_py; print(ctest_py.curl_version())"

      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-linux-x86_64
          path: wheelhouse/*.whl
